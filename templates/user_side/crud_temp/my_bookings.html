{% extends 'user_side/index.html' %}

{% block title %}My Bookings{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">My Bookings</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="bookingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming"
                type="button" role="tab">Upcoming</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ongoing-tab" data-bs-toggle="tab" data-bs-target="#ongoing" type="button"
                role="tab">Ongoing</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="past-tab" data-bs-toggle="tab" data-bs-target="#past" type="button"
                role="tab">Completed</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="archived-tab" data-bs-toggle="tab" data-bs-target="#archived" type="button"
                role="tab">Cancelled</button>
        </li>
    </ul>

    <div class="tab-content pt-3" id="bookingTabsContent">

        <!-- UPCOMING -->
        <div class="tab-pane fade show active" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
            {% if upcoming %}
            <div class="row g-3">
                {% for b in upcoming %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm">
                        <!-- {% set cover = (b.property.property_photos.split(',')[0] if b.property and
                        b.property.property_photos else None) %}
                        {% if cover %}
                        <img src="/{{ cover }}" class="card-img-top" alt="Property photo"> 
                        {% endif %} -->
                        <div class="card-body">
                            <h5 class="card-title mb-1">{{ b.property.property_name if b.property else 'Property' }}
                            </h5>
                            <div class="text-muted small mb-2">
                                {{ b.property.city }}, {{ b.property.country }} • {{ b.property.property_type }}
                            </div>
                            <div class="mb-2"><strong>Room:</strong> {{ b.room.room_type if b.room else 'Room' }}</div>
                            <div class="mb-2"><strong>Booking Code:</strong> {{ b.booking_code }}</div>
                            <div class="mb-1"><strong>Check‑in:</strong> {{ b.start_date.strftime('%d %b %Y') }}</div>
                            <div class="mb-2"><strong>Check‑out:</strong> {{ b.end_date.strftime('%d %b %Y') }}</div>
                            <span class="badge bg-info text-dark">{{ b.status }}</span>
                        </div>
                        <div class="card-footer bg-white d-flex">
                            <!-- Placeholder for actions (e.g., cancel/reschedule) -->
                            <form method="POST" action="{{ url_for('cancel_booking', booking_id=b.id) }}"
                                onsubmit="return confirm('Cancel this booking?');">
                                {# If you use Flask-WTF/CSRF, include the token here #}
                                <button type="submit" class="btn btn-danger btn-sm">Cancel</button>    
                            </form>
                            <a href="{{ url_for('view_booking_page', booking_id=b.id) }}" class=" btn btn-primary btn-sm ms-2">View</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">You have no upcoming bookings.</div>
            {% endif %}
        </div>

        <!-- ONGOING -->
        <div class="tab-pane fade" id="ongoing" role="tabpanel" aria-labelledby="ongoing-tab">
            {% if ongoing %}
            <div class="row g-3">
                {% for b in ongoing %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm">
                        <!-- {% set cover = (b.property.property_photos.split(',')[0] if b.property and
                        b.property.property_photos else None) %}
                        {% if cover %}
                        <img src="/{{ cover }}" class="card-img-top" alt="Property photo">
                        {% endif %} -->
                        <div class="card-body">
                            <h5 class="card-title mb-1">{{ b.property.property_name if b.property else 'Property' }}
                            </h5>
                            <div class="text-muted small mb-2">
                                {{ b.property.city }}, {{ b.property.country }} • {{ b.property.property_type }}
                            </div>
                            <div class="mb-2"><strong>Room:</strong> {{ b.room.room_type if b.room else 'Room' }}</div>
                            <div class="mb-2"><strong>Booking Code:</strong> {{ b.booking_code }}</div>
                            <div class="mb-1"><strong>Check‑in:</strong> {{ b.start_date.strftime('%d %b %Y') }}</div>
                            <div class="mb-2"><strong>Check‑out:</strong> {{ b.end_date.strftime('%d %b %Y') }}</div>
                            <span class="badge bg-success">Ongoing</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">You have no ongoing stays.</div>
            {% endif %}
        </div>

        <!-- PAST -->
        <div class="tab-pane fade" id="past" role="tabpanel" aria-labelledby="past-tab">
            {% if past %}
            <div class="row g-3">
                {% for b in past %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm">
                        <!-- {% set cover = (b.property.property_photos.split(',')[0] if b.property and
                        b.property.property_photos else None) %}
                        {% if cover %}
                        <img src="/{{ cover }}" class="card-img-top" alt="Property photo">
                        {% endif %} -->
                        <div class="card-body">
                            <h5 class="card-title mb-1">{{ b.property.property_name if b.property else 'Property' }}
                            </h5>
                            <div class="text-muted small mb-2">
                                {{ b.property.city }}, {{ b.property.country }} • {{ b.property.property_type }}
                            </div>
                            <div class="mb-2"><strong>Room:</strong> {{ b.room.room_type if b.room else 'Room' }}</div>
                            <div class="mb-2"><strong>Booking Code:</strong> {{ b.booking_code }}</div>
                            <div class="mb-1"><strong>Check‑in:</strong> {{ b.start_date.strftime('%d %b %Y') }}</div>
                            <div class="mb-2"><strong>Check‑out:</strong> {{ b.end_date.strftime('%d %b %Y') }}</div>
                            <span class="badge bg-secondary">{{ b.status }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">You have no past bookings.</div>
            {% endif %}
        </div>

        <!-- ARCHIVED / HISTORY/ Cancelled -->
        <div class="tab-pane fade" id="archived" role="tabpanel" aria-labelledby="archived-tab">
            {% if archived %}
            <div class="row g-3">
                {% for b in archived %}
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100 shadow-sm">

                        {# Cover photo logic #}
                        <!-- {% set cover = (b.property.property_photos.split(',')[0] if b.property and
                        b.property.property_photos else None) %}
                        {% if cover %}
                        <img src="/{{ cover }}" class="card-img-top" alt="Property photo">
                        {% else %}
                        <img src="/static/default-property.jpg" class="card-img-top" alt="Default photo">
                        {% endif %} -->

                        <div class="card-body">
                            <h5 class="card-title mb-1">
                                {{ b.property.property_name if b.property else 'Property Name' }}
                            </h5>
                            <div class="text-muted small mb-2">
                                {{ b.property.city if b.property else 'City' }},
                                {{ b.property.country if b.property else 'Country' }} •
                                {{ b.property.property_type if b.property else 'Type' }}
                            </div>

                            <div class="mb-2">
                                <strong>Room:</strong> {{ b.room.room_type if b.room else 'Room Info' }}
                            </div>

                            <div class="mb-2">
                                <strong>Booking Code:</strong> {{ b.booking_code }}
                            </div>

                            <div class="mb-1">
                                <strong>Check‑in:</strong> {{ b.start_date.strftime('%d %b %Y') }}
                            </div>

                            <div class="mb-2">
                                <strong>Check‑out:</strong> {{ b.end_date.strftime('%d %b %Y') }}
                            </div>

                            <span class="badge bg-danger">{{ b.status }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-muted">No archived bookings.</div>
            {% endif %}
        </div>


    </div>
</div>
{% endblock %}